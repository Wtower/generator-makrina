generator-makrina 
=================

[![NPM version][npm-image]][npm-url] 
[![Build Status][travis-image]][travis-url] 
[![Coverage Status](https://coveralls.io/repos/github/Wtower/generator-makrina/badge.svg?branch=master)](https://coveralls.io/github/Wtower/generator-makrina?branch=master) 
[![Dependency Status][daviddm-image]][daviddm-url] 
[![npm](https://img.shields.io/npm/dt/generator-makrina.svg?maxAge=2592000)](https://www.npmjs.com/package/generator-makrina)

[npm-image]: https://badge.fury.io/js/generator-makrina.svg
[npm-url]: https://npmjs.org/package/generator-makrina
[travis-image]: https://travis-ci.org/Wtower/generator-makrina.svg?branch=master
[travis-url]: https://travis-ci.org/Wtower/generator-makrina
[daviddm-image]: https://david-dm.org/Wtower/generator-makrina.svg?theme=shields.io
[daviddm-url]: https://david-dm.org/Wtower/generator-makrina

Generate MEAN boilerplate. Featuring model and route CRUD endpoint sub-generators and an admin interface.

Makrina generates a starting project with the following stack and features.

### Technology Stack

- Mongo DB
- Express.js
- Angular JS
- Node.js

### Features

- [EJS templates](https://github.com/tj/ejs)
- An admin interface based on [Gentelella admin theme](#admin-template)
- Latest [Angular v1.5.8](#angular) scaffolding created by sub-generators
- [Mongoose](#mongoose) models created by sub-generators
- API route endpoints for the models
- An extended gulpfile for building and testing
- [Test-ready](#tests) using mocha, chai, sinon, karma, protractor.
- Generated code should have already 100% coverage or nearly.
- [CSRF](#csrf) protection.


Contents
--------

- [Installation](#installation)
- [Sub-generators](#sub-generators)
- [Description](#description)
- [Prompts](#prompts)
- [Development cycle](#development-cycle)

In the [Installation](#installation) section we describe how to install and use Makrina.
Then, in the [Sub-generators](#sub-generators) we outline how to use specific Makrina features.
The [Description](#description) section provides a more thorough description of Makrina.
The [Prompts](#prompts) section summarizes all input that the generator requires as a reference.
Last, the [Development cycle](#development-cycle) topic provides a more thorough description of the 
development cycle of a MEAN project generated by Makrina.


Installation
------------

First, install [Yeoman](http://yeoman.io) and generator-makrina using [npm](https://www.npmjs.com/) 
(we assume you have pre-installed [node.js](https://nodejs.org/)).

```bash
npm install -g yo
npm install -g generator-makrina
```

Then generate your new project:

```bash
yo makrina
```

Sub-generators
--------------

Called by app generator:

- `angular-app`: Generate an Angular application.
- `angular-core-service`: Generate a `core.object` module containing an `ngResource` factory.
- `angular-component-list`: Generate a component for displaying a list.
- `angular-component-detail`: Generate a component for displaying an object.
- `model`: Generate a mongoose model with api endpoint for express.

Not called by app generator: 

- `angular-controller-form`: Generate a simple module with a controller to handle a form submit.

How to use:

```bash
yo makrina:angular-app
```

Description
-----------

The generator creates a new project featuring:

### Main app generator

- A default `package.json` file with the appropriate description and dependencies for the following.
- Default meta documents: `README`, private `LICENCE`, `CONTRIBUTING`, `CHANGELOG`.
- Default `gitignore` and `editorconfig` files
- Standard express.js boilerplate: `app.js`, `bin/`, `public/`, `routes/`, `views/`.
- A default `gulpfile` mainly for managing front-end files.
- Standard karma and protractor (e2e) configuration.
- A `services` folder with most configuration scripts: mongoose, session, i18n, email.
- Default routes & views for index, admin interface and contact form.

It then calls the following sub-generators for an angular application with basic REST CRUD functionality 
for a single object. Repeat calling the sub-generators on their own to add more objects.

### Angular app sub-generator

This is called by app generator or stand-alone. It creates a standard Angular 1.5.8 scaffolding:

- A main app module
- An angular config file 
- An additional jquery file with app-related jquery functions
- An additional SASS file with app-related styling
- An animations SASS file with ng-animate styling
- An additional core sub-module for facilitating common core functions (factories, filters) in the future.

Usually this intended for an admin app with basic CRUD functionality using the sub-generators below.

### Angular core service

This is called after the angular app sub-generator (or stand-alone). It creates:

- An additional core sub-module to facilitate an object factory service (REST communication with server).
- The actual service file
- A unit tests file

### Angular list component

This is called after the angular core service (or stand-alone). It creates:

- An additional sub-module to display an object list based on the above service.
- A default angular 1.5.4 component for the list
- The angular template for the list
- A unit tests file
- An e2e scenarios file

### Angular detail component

This is called after the angular list component (or stand-alone). It creates:

- An additional sub-module to display an object form.
- A default angular 1.5.4 component to allow get, post, delete
- The angular template for the form
- A unit tests file
- An e2e scenatios file

### Angular form controller

A small controller to post a form such as a contact message and handle the form submit button status.
Not called by main app generator.

Prompts
-------

The generator asks the following.

### General

- Project name: the generated project name (no spaces).
  Used in: `package.json, README.md, newrelic.js, services/mongoose.js`.
  
- Verbose name: a verbose project name, spaces allowed.
  Used in: `newrelic.js, routes/index.js, routes/admin.js, routes/api/contact.js`.

- Description: project description.
  Used in: `package.json, README.md, routes/index.js, views/index.ejs`.

- Git repository URL. Used in `package.json`.

- Author. Used in `package.json, LICENSE, CONTRIBUTING.md, views/index.ejs`.

- Organization: Organization name for author.
  Used in: `views/index.ejs, views/login.ejs, views/admin.ejs`.

- Organization URL. Used in `views/login.ejs, views/admin.ejs`.

- Deploy host: optional for `npm deploy` command.
  Used in: `package.json`.

- New Relic license key. Used in `newrelic.js`.


### Angular app

- Angular app short name: the short name for the app, eg. `admin` or `app`.
  Used in: destination prefix for the files of the sub-generators: 
  angular-app, angular-core-service, angular-component-list, angular-component-detail.

- Angular app name: the full name for the app, eg `myProjectAdminApp`.
  Used in: `_angular-app-name_.module.js, views/admin.ejs`.


### Object

The object is usually a single entity, such as `node`, `page`, etc.
It has its own mongoose model, api endpoint and angular service and component.

- Object name (recommended camelCase).
- Object title (recommended PascalCase).
- Object API URL and directory name (recommended kebab-case).


Development Cycle
-----------------

- (0) Environment setup
  - Prepare OS
     - [Install node.js](https://github.com/Wtower/express-experiment#install-node)
     - [Install mongodb](#install-mongodb)
     - [Install global packages](#install-global-packages)
     - [Install yeoman and makrina](#installation)
  
  - Start project
     - [Use makrina](#installation): `yo makrina`
     - Review [generated files](https://github.com/Wtower/generator-makrina/blob/master/generators/app/templates)
     - Review meta documents (README, LICENSE, CONTRIBUTING, CHANGELOG)

  - Configure packages
     - Review `package.json`
     - Review `gulpfile.js`
     - Start with `npm start` or `node bin/www`

- (A) [Angular](#angular) and front-end
  - (0) Bootstrapping
     - Review `views/index.ejs`
     - Review [admin template](#admin-template)
     - Review and add js files in gulp
     
  - (1) Static template
     - Add static files
     - Style up
     - Review and add sass/css files in gulp

  - (2) Angular setup
     - Review `public/javascripts/app` folder
     - Review `karma.conf.js` for [tests](#tests)
  
  - (3) Components
     - Review list component `object-list.component.js`
     - Review list unit test `object-list.component.spec.js`
  
  - (4) Module and file Organization
     - Review `app.module.js` and inject any additional module dependency
     - Review list template `object-list.template.html`
  
  - (5) Filters
     - Add custom filters to list 

  - (6) Extend e2e tests
     - Review `protractor.conf.js`
     - Review e2e tests `e2e-tests/app.scenarios.js`

  - (7) XHR
  - (8) Templating list
     - Expand on the list template
  
  - (9) Angular Routing
     - Template: review `ng-view`
     - Dependency: using `angular-route`. Review `app.module.js`
     - Configure in `app.config.js`
     - Review detail component `object-detail/object-detail.component.js`
     - Review detail module `object-detail.module.js` and inject in `app.module.js`
     - Extend e2e tests
  
  - (10) Templating detail
     - Expand on the detail template
     - Review `node-detail.component.spec.js`
     - Extend e2e tests
  
  - (11) Core module
     - Review core module `core/core.module.js` and inject in `app.module.js`
     - Add custom filters in `core/filter_name/filter_name.filter.js` (optional)
     - Add unit tests in `filter_name.filter.spec.js`
  
  - (12) Event handlers
  - (13) REST and custom services factory
     - Dependency: using `angular-resource`
     - Review module `core/object/object.module.js` with dependency to `ngResource`
     - Review service `object.service.js`
     - Inject `core.object` to `core.module.js`, `object-list.component.js`, `object-detail.component.js`
     - Review unit test `object.service.spec.js`
  
  - (14) Animations
     - Dependency: using `angular-animate` in `app.module.js`
     - Review `app.animations.sass`
     - Review template: jquery loaded in head, relevant classes to `ng-view`
     - Extend animations with js
    
- (B) Node and back-end

  - Models: [Mongoose](#mongoose)
     - Review `services/mongoose.js`
     - Review and create `models/`
     - Review express-session in `services/session-config.js`
     - Add [CSRF](#csrf) to non-Angular forms
     - Review `newrelic.js`.
  
  - Routes: Express
     - Review [i18n](https://github.com/mashpie/i18n-node) urls in `services/i18n-config.js` and `routes/index.js`
     - Connect Angular service to routes: review `routes/api/`.

  - Breadcrumb

Environment setup
-----------------

### Install Mongodb

Latest Mongodb (at the time of writing) is v3.2. 
Ubuntu 16.04 comes with v2.6.
Ubuntu 14.04 comes with v2.4 (see [how to upgrade]
(https://www.digitalocean.com/community/questions/how-to-upgrade-mongodb-2-4-to-2-6-on-ubuntu-14-04)).
Version 2.6 will be used throughout due to availability on hosts.

### Install global packages

    ~/.nvm/v4.4.7/lib
    ├── gulp-cli@1.2.1
    ├── karma-cli@1.0.1
    └── npm@3.10.6

Install with:

    nvm install 4
    npm update -g npm
    npm install -g gulp-cli karma-cli

Angular
-------

The outline follows the [Angular tutorial](https://docs.angularjs.org/tutorial).
Gulpfile is configured to concatenate the angular app.

### Sanitize

`angular-sanitize` can be used to present a sanitized scope variable with `ng-bind-html` 
[more](http://stackoverflow.com/questions/25548485/angular-js-how-can-i-sanitize-html-in-a-controller/38511134#38511134).

To further sanitize HTML stored in db, the module [mongoose-html](https://github.com/homerquan/mongoose-html)
can be used. The project is abandoned and has unmet peer dependencies so don't install it directly, the relevant
piece of code is very small and can be used directly.

It is based on [sanitize-html](https://github.com/punkave/sanitize-html) which can be used at a lower level.
It is not possible to easily use it though with [custom validators](http://mongoosejs.com/docs/validation.html)
as they do not return the value but only a boolean, and also they are yet harder to use within objects.

Tests
-----

### Unit tests

All unit tests can be invoked from `npm test`, which essentially invokes `gulp test`.

    npm test

Unit tests involve front-end tests with karma and back-end tests with mocha.
Both provide coverage report using istanbul.

### End-to-end tests

    npm start
    npm run protractor

Server needs to have started before. 
Protractor can only run in local.
Protractor is tested only for Chrome due to [#3044](https://github.com/angular/protractor/issues/3044).

    npm start
    node_modules/protractor/bin/webdriver-manager update
    node_modules/protractor/bin/protractor e2e-tests/protractor.conf.js

Admin template
--------------

The [Gentelella admin theme](https://github.com/puikinsh/gentelella) is adopted into `views/admin.ejs`.
The adaptations include:

- Most static files are loaded from minified output from gulpfile.
- Context is provided from `routes/admin.js`.
- The main view is adopted for Angular route using `ng-view`.
- Also, a `views/login.ejs` template has been added.

Mongoose
--------

The files `servives/mongoose.js` and `models/object.js` need to be reviewed.

Models are used in routes by requiring:

    var mongoose = require('mongoose');
    var Object = mongoose.model('Object');

### Mongoose quick reference

- [Quickstart](http://mongoosejs.com/docs/index.html)
- [Guide](http://mongoosejs.com/docs/guide.html)
- [Schema definition and types](http://mongoosejs.com/docs/schematypes.html)
- [Updating nested objects](http://stackoverflow.com/questions/23832921/updating-nested-object-in-mongoose)
- [Field update operators](https://docs.mongodb.com/manual/reference/operator/update-field/)

### Sanitize and injection

[Mongodb injection](http://blog.websecurify.com/2014/08/hacking-nodejs-and-mongodb.html) is very much possible
with mongo queries, especially when a where criterion is provided from a public form or url. 
The module [mongo-sanitize](https://www.npmjs.com/package/mongo-sanitize) can be easily used to sanitize 
`req.body` and `req.query` from mongo `$` operators.

CSRF
----

CSRF protection is guarded by the Csurf package. 
Angular forms respect CSRF due to the `XSRF-TOKEN` cookie that we make in `app.js`. 
All other forms require manual append of CSRF:

- In router context: `context.csrf = req.csrfToken();`
- In forms: `<input type="hidden" name="_csrf" value="<%= csrf %>">`

The responses are automatically checked by the module and 403 is returned appropriately.
This is tested in mocha too.

Useful links
------------

### Generic MEAN REST tutorials

- https://thinkster.io/mean-stack-tutorial
- http://adrianmejia.com/blog/2014/10/01/creating-a-restful-api-tutorial-with-nodejs-and-mongodb/
- https://scotch.io/tutorials/using-mongoosejs-in-node-js-and-mongodb-applications

### Testing

- http://developers.redhat.com/blog/2016/03/15/test-driven-development-for-building-apis-in-node-js-and-express/
- https://codeforgeek.com/2015/07/unit-testing-nodejs-application-using-mocha/


Updates
-------

Most generated code gets signed by the Makrina version and date in a comment at the top of file.
All changes are documented in `CHANGELOG.md`. If you feel like using a latest feature or change,
you can manually update the relevant files, and append the Makrina version in the comment for 
future reference:

    * Updated to yeoman generator-makrina <%= version %> on <%= date %>.

Or re-run the generator by carefully selecting which files to replace when asked.


License
-------

MIT © [Wtower](https://github.com/Wtower)
